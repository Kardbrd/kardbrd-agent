services:
  agent:
    build:
      context: ./repository
      target: agent                                # uses the agent target from your Dockerfile
      # dockerfile: Dockerfile.agent               # uncomment if using a separate Dockerfile.agent
    user: "1000:1000"
    restart: unless-stopped
    environment:
      - KARDBRD_ID                                 # Board ID (required)
      - KARDBRD_TOKEN                              # Bot token (required)
      - KARDBRD_AGENT                              # Agent name for @mentions (required)
      # - KARDBRD_URL=https://app.kardbrd.com      # API URL (optional)
      - ANTHROPIC_API_KEY
      # - AGENT_EXECUTOR=goose                         # Uncomment for Goose executor
      # - GOOSE_PROVIDER=anthropic                     # Required when using Goose (e.g. anthropic, openai, ollama)
      - LOG_LEVEL=INFO
      - AGENT_CWD=/home/agent/repository
      - AGENT_WORKTREES_DIR=/home/agent/workspaces
      - AGENT_SETUP_CMD=pnpm install              # Match your project's install command
      - AGENT_TEST_CMD=pnpm build                  # Match your project's build/test command
      - AGENT_MAX_CONCURRENT=2
      - AGENT_TIMEOUT=7200
      - GIT_AUTHOR_NAME=Kardbrd Agent
      - GIT_AUTHOR_EMAIL=agent@example.com
      - GIT_COMMITTER_NAME=Kardbrd Agent
      - GIT_COMMITTER_EMAIL=agent@example.com
    volumes:
      # Base repository (read-write)
      - ./repository:/home/agent/repository

      # Worktrees (separate from repo)
      - ./workspaces:/home/agent/workspaces

      # Claude CLI home (API creds, session data, settings)
      - ./claude:/home/agent/.claude

      # SSH key (read-only) â€” use a DEDICATED key, not personal
      - ./ssh/id_ed25519:/home/agent/.ssh/id_ed25519:ro
